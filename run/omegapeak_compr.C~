#include "../header/plot.h"
#include "../header/sm_para.h"

TRandom *generator = new TRandom();
TRandom *rnd=0;
rnd=new TRandom3();

//
double DetectorEvent_fcn(double m, double *para_tmp) {
  // m[0]: mTrue
  // para[0] = frac
  // para[1] = smallBias
  // para[2] = smallSigma
  // para[3] = wideBias
  // para[4] = wideSigma

  // smear by double-gaussian
  if(rnd->Rndm()>para_tmp[0]) {
    return rnd->Gaus(m+para_tmp[1],para_tmp[2]);
  } else {
    return rnd->Gaus(m+para_tmp[3],para_tmp[4]);
  }
}

// Linear background function
Double_t background(Double_t *x, Double_t *par) {
  return par[0] + par[1]*x[0];
}

// Gaussian peak function with 3 parameters
double gaussianPeak(double *x, double *par) {
  double r1 = (x[0] - par[1]) / par[2];
  double fitval = par[0] * TMath::Exp(-0.5 * r1 * r1);
  //cout << par[0] << ", " << par[1] << ", " << par[2] << endl;
  return fitval;
}

// Sum of background and peak function
Double_t fitFunction(Double_t *x, Double_t *par) {
  //double *p1 = &par[0];
  //double *p2 = &par[2];
  //cout << par[0] << endl;
  //return gaussianPeak(x, par);
  return background(x, &par[3]) + gaussianPeak(x, par);
}

int omegapeak_compr() {

  //gROOT->SetBatch(kTRUE);  
  gErrorIgnoreLevel = kError;
  TGaxis::SetMaxDigits(4);
  gStyle->SetOptStat(0);
  gStyle->SetOptTitle(0);
  //gROOT->SetStyle("Plain");
  //gROOT->ForceStyle();
  
  // get root input files from: ~/Desktop/analysis_root_v6/sf_2g/plot_hist.C (smeared signal 3pi invariant mass distribution)
  // /home/bo/Desktop/analysis_root_v6/sf_1g/plot_hist.C (reconstructed signal 3pi invariant mass distribution)

  // input smeared
  TFile* intree_smear = new TFile("/home/bo/Desktop/analysis_root_v6/sf_2g/plot_hist.root");
  cout << intree_smear -> GetName() << endl;
  
  TIter next_tree(intree_smear -> GetListOfKeys());

  TString objnm_tree, classnm_tree;

  int i = 0;
  TKey *key;
  
  while ( (key = (TKey *) next_tree() ) ) {
    
    i ++;
    
    objnm_tree   =  key -> GetName();
    classnm_tree = key -> GetClassName();
    key -> GetSeekKey();
    
    cout << "tree" << i << ": classnm = " << classnm_tree << ", objnm = " << objnm_tree << endl;
    
  }

  TH1D* hIM3pi_smeared = (TH1D *)intree_smear -> Get("hIM3pi_isr3pi_sc_corr");

  double xmin = hIM3pi_smeared -> GetXaxis() -> GetXmin();
  double xmax = hIM3pi_smeared -> GetXaxis() -> GetXmax();

  const double binsize = hIM3pi_smeared -> GetNbinsX(); //cout<<"binsize = " << binsize << endl;
  
  double totalEvents = hIM3pi_smeared -> GetEntries();
  cout << "event yields = " << totalEvents << endl;
  
  // input good reconstructed omega peak events
  const TString infile_nm="/home/bo/Desktop/analysis_root_v6/input_norm_TDATA";
  TFile *inputfile = new TFile(infile_nm + "/input/sig.root"); 

  TTree *ALLCHAIN_CUT = (TTree*)inputfile -> Get("ALLCHAIN_CUT");

  int phid = 9999;
  int bkg_indx = 9999;
  int sig_type = 9999;
  int recon_indx = 9999;
  
  double IM3pi = 0., IM3pi_true = 0.;
  double IM3pi_smeared = 0.;
  double PARA[5] = {frac, smallBias, smallSigma, wideBias, wideSigma};
  

  TH1D *hIM3piomega_good = new TH1D("hIM3piomega_good", "", binsize, xmin, xmax);
  TH1D *hIM3piomega_bad = new TH1D("hIM3piomega_bad", "", binsize, xmin, xmax);
  TH1D *hIM3piomega_rec = new TH1D("hIM3piomega_rec", "", binsize, xmin, xmax);
  TH1D *hIM3piomega_smeared = new TH1D("hIM3piomega_smeared", "", binsize, xmin, xmax);
  
  for (Int_t irow = 0; irow < ALLCHAIN_CUT -> GetEntries(); irow++) {// loop chain

    ALLCHAIN_CUT -> GetEntry(irow);

    phid = ALLCHAIN_CUT -> GetLeaf("Br_phid") -> GetValue(0);
    sig_type = ALLCHAIN_CUT -> GetLeaf("Br_sig_type") -> GetValue(0);
    bkg_indx = ALLCHAIN_CUT -> GetLeaf("Br_bkg_indx") -> GetValue(0);
    recon_indx = ALLCHAIN_CUT -> GetLeaf("Br_recon_indx") -> GetValue(0);

    IM3pi_true = ALLCHAIN_CUT -> GetLeaf("Br_IM3pi_true") -> GetValue(0);

    IM3pi_smeared = DetectorEvent_fcn(TMath::Abs(IM3pi_true), PARA);
    
    IM3pi = ALLCHAIN_CUT -> GetLeaf("Br_IM3pi_7C") -> GetValue(0);
    
    if (phid == 0) {// e+ e- -> omega pi0

      if (recon_indx == 2 && bkg_indx == 1) {
	//h2d_good -> Fill(IM3pi_true, IM3pi);
	hIM3piomega_good -> Fill(IM3pi);
	hIM3piomega_rec -> Fill(IM3pi);
    
      	//cout << IM3pi_true << ", " << IM3pi << endl;
	
	//h1d_resol_Eisr -> Fill(Eisr_resol);
      }
      else {
	//h2d_bad -> Fill(IM3pi_true, IM3pi);
	hIM3piomega_bad -> Fill(IM3pi);
      	//hist_wrong -> Fill(IM3pi);
	//h2d_scatter_wrong -> Fill(IM3pi_true, IM3pi);
      }
      
    }

    hIM3piomega_smeared -> Fill(IM3pi_smeared);
    
    if (irow > totalEvents) break;
    
  }

  // Fit smeared
  const int npar = 5;
  double rms = hIM3piomega_smeared -> GetRMS();
  double mean = hIM3piomega_smeared -> GetMean();
  double peak = hIM3piomega_smeared -> GetMaximum();
  double fitpara[npar] = {peak, mean, rms, 1, 1};
  
  cout << "smear mass range = [" << xmin << ", " << xmax << "] MeV/c^2 \n"
       << "rms = " << rms << ", mean = " << mean << ", peak = " << peak << "\n";

  const double fit_min = 774, fit_max = 792;
  double binwidth=(xmax-xmin)/binsize; //cout<<width<<endl;

  TF1 *fitFcn = new TF1("fitFcn", fitFunction, fit_min, fit_max, 5);
  fitFcn -> SetParameters(fitpara);

  
  //fitFcn -> SetLineColor(kBlue);
  //fitFcn -> SetLineWidth(2);
  //fitFcn -> SetNpx(10000);
  
  TFitResultPtr r = hIM3piomega_smeared -> Fit("fitFcn", "LM0", "", fit_min, fit_max);

  TF1 *fit_fun = hIM3piomega_smeared -> GetFunction("fitFcn");
  fit_fun -> SetLineColor(kRed);
  fit_fun -> SetLineStyle(1);
  fit_fun -> SetLineWidth(2);
  fit_fun -> SetNpx(10000);

  // Fit reconstructed
  double xmin_rec = hIM3piomega_rec -> GetXaxis() -> GetXmin();
  double xmax_rec = hIM3piomega_rec -> GetXaxis() -> GetXmax();
  double rms_rec = hIM3piomega_rec -> GetRMS();
  double mean_rec = hIM3piomega_rec -> GetMean();
  double peak_rec = hIM3piomega_rec -> GetMaximum();
  double fitpara_rec[npar] = {peak_rec, mean_rec, rms_rec, 1, 1};

  cout << "rec mass range = [" << xmin_rec << ", " << xmax_rec << "] MeV/c^2 \n"
       << "rms_rec = " << rms_rec << ", mean_rec = " << mean_rec << ", peak_rec = " << peak_rec << "\n";

  double rms_diff = TMath::Abs(rms - rms_rec);
  cout << "rms difference: (rms - rms_rec) = " << rms_diff << "%\n";

  double width_smear = fitFcn -> GetParameter(2);
  double width_smear_err = fitFcn -> GetParError(2);
  double width_rec = fitFcn -> GetParameter(2);
  double width_rec_err = fitFcn -> GetParError(2);
  double width_diff = TMath::Abs(width_smear - width_rec);
  double Z_width = width_diff / TMath::Sqrt(width_rec_err * width_rec_err + width_smear * width_smear);
  
  cout << "width_smear = " << width_smear << "+/-" << width_smear_err << "\n"
       << "width_rec = " << width_rec << "+/-" << width_rec_err << "\n"
       << "width_diff = " << width_diff << ", rel. diff. = " << width_diff / width_smear * 100. << "%\n"
       << "Z_width = " << Z_width << endl;

  const double fit_min_rec = 775, fit_max_rec = 793;

  TF1 *fitFcn_rec = new TF1("fitFcn_rec", fitFunction, fit_min_rec, fit_max_rec, 5);
  fitFcn_rec -> SetParameters(fitpara_rec);

  TFitResultPtr r_rec = hIM3piomega_rec -> Fit("fitFcn_rec", "LM0", "", fit_min_rec, fit_max_rec);
  TF1 *fit_fun_rec = hIM3piomega_rec -> GetFunction("fitFcn_rec");
  fit_fun_rec -> SetLineColor(kGreen);
  fit_fun_rec -> SetLineStyle(1);
  fit_fun_rec -> SetLineWidth(2);
  fit_fun_rec -> SetNpx(10000);
  
  //hIM3piomega_good -> Draw();
  //hIM3piomega_bad -> Draw("Same");
  hIM3piomega_rec -> Draw();
  hIM3piomega_smeared -> Draw("Same");

  return 0;
  
}
